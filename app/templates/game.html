<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä¸ƒä¸¦ã¹</title>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
#hand { margin: 20px; }
.card { display: inline-block; width: 60px; height: 90px; border: 1px solid #000; text-align:center; line-height:90px; margin: 3px; cursor:pointer; }
#table { margin: 20px; }
.suit { margin: 10px 0; }
</style>
</head>
<body>
<h1>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸ƒä¸¦ã¹</h1>
<div id="table"
     style="
        display: grid;
        grid-template-columns: repeat(13, 60px);
        grid-template-rows: repeat(4, 90px);
        gap: 2px;
        justify-content: center;
        margin-top: 40px;
        background-color: #0b6623;
        padding: 10px;
        border-radius: 8px;
     ">
</div>
    <div class="suit" id="hearts"></div>
    <div class="suit" id="spades"></div>
    <div class="suit" id="diamonds"></div>
    <div class="suit" id="clubs"></div>
</div>

<style>
#table {
  display: grid;
  grid-template-columns: repeat(13, 80px); /* æ¨ª13åˆ— */
  grid-template-rows: repeat(4, 120px);    /* ç¸¦4è¡Œ */
  gap: 6px;
  justify-content: center;
  margin: 24px auto;
  background: #0b6623;
  padding: 12px;
  border-radius: 8px;
  width: fit-content;
}
.row {
  display: flex;
  gap: 4px;
}
.slot {
  width: 80px;
  height: 120px;
  background-color: rgba(255,255,255,0.03);
  border-radius: 6px;
  border: 1px solid rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden; /* ç”»åƒãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
}

.card {
  width: 70px;
  height: 100px;
}
.slot img.card {
  width: 100%;
  height: 100%;
  object-fit: contain; /* ç”»åƒã®ç¸¦æ¨ªæ¯”ã‚’ä¿ã£ã¦åã‚ã‚‹ */
  pointer-events: none; /* ç”»åƒä¸Šã§ã‚¯ãƒªãƒƒã‚¯ãŒäºŒé‡ã«ãªã‚‰ãªã„ã‚ˆã†ã« */
}

#hand {
  display: flex;
  justify-content: center;
  margin-top: 20px;
  gap: 5px;
}
</style>


<h3>ã‚ãªãŸã®æ‰‹æœ­</h3>
<div id="hand"
     style="
        position: fixed;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 5px;
        background-color: rgba(255,255,255,0.2);
        padding: 10px;
        border-radius: 10px;
     ">
</div>
<script>
const socket = io();

const username = "{{ username }}";
const room = "{{ room_id }}"; // ç°¡æ˜“ç‰ˆ: å›ºå®šãƒ«ãƒ¼ãƒ 

console.log("usename : " + username);
console.log("room_id : " + room);
socket.emit("join_game", {username, room});
const suits = ["H", "S", "D", "K"]; // å„ã‚¹ãƒ¼ãƒˆã‚’ä¸Šã‹ã‚‰é †ã«è¡Œã¨ã—ã¦ä½¿ã†
const suitNames = { H: "hearts", S: "spades", D: "diamonds", K: "clubs" };

/*
socket.on("update_hands", hands => {
    const myHand = hands[username];

    // ğŸ”¹ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è‡ªåˆ†ã®æ‰‹æœ­ã‚’è¡¨ç¤º
    console.log("ğŸ“¥ å—ä¿¡ã—ãŸæ‰‹æœ­:", myHand);
    const handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";
    myHand.forEach(card => {
        const c = document.createElement("div");
        c.className = "card";
        c.textContent = card;
        c.onclick = () => {
            socket.emit("play_card", {username, room, card});
        }
        handDiv.appendChild(c);
    });
});
*/
function initTable() {
    const table = document.getElementById("table");
    table.innerHTML = "";

    // å„ã‚¹ãƒ¼ãƒˆè¡Œã«13åˆ—ã®ã‚»ãƒ«ã‚’ä½œæˆ
    for (let row = 0; row < suits.length; row++) {
        for (let col = 1; col <= 13; col++) {
            const cell = document.createElement("div");
            cell.id = `${suits[row]}${col}_cell`;
            cell.style.width = "60px";
            cell.style.height = "90px";
            cell.style.border = "1px solid #444";
            cell.style.borderRadius = "6px";
            cell.style.backgroundColor = "rgba(255,255,255,0.1)";
            cell.style.display = "flex";
            cell.style.alignItems = "center";
            cell.style.justifyContent = "center";
            table.appendChild(cell);
        }
    }
}

initTable();

function sortCards(cards) {
    const order = { H: 0, S: 1, D: 2, K: 3 };
    return cards.sort((a, b) => {
        const suitA = order[a[0]];
        const suitB = order[b[0]];
        if (suitA !== suitB) return suitA - suitB;
        return parseInt(a.slice(1)) - parseInt(b.slice(1));
    });
}

/*
socket.on("update_hands", hands => {
    console.log("hands:", hands);

    // è‡ªåˆ†ã®æ‰‹æœ­ã ã‘è¡¨ç¤º
    const myHand = hands[username];
    if (!myHand) return;
    const suitsOrder = ["H","S","D","K"];
    let sortedHand = sortCards([...myHand]);


    const handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";

    for (const suit of suits) {
        const seven = `${suit}7`;
        if (sortedHand.includes(seven)) {
            const cell = document.getElementById(`${seven}_cell`);
            if (cell) {
                const img = document.createElement("img");
                img.src = `/static/cards/${seven}.png`;
                img.alt = seven;
                img.style.width = "60px";
                img.style.height = "90px";
                cell.appendChild(img);
            }
            // æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
            sortedHand = sortedHand.filter(c => c !== seven);
        }
    }

    myHand.forEach(card => {
        const c = document.createElement("div");
        c.className = "card";
        
        const img = document.createElement("img");
        img.src = `/static/cards/${card}.png`;
        img.alt = card;
        img.style.width = "60px";
        img.style.height = "90px";
        img.style.cursor = "pointer";

        img.onclick = () => {
            socket.emit("play_card", {username, room, card});
        };

        c.appendChild(img);
        handDiv.appendChild(c);
    });

    

});
*/

socket.on("update_hand", data => {
    if (data.username === username) {
        const handDiv = document.getElementById("hand");
        handDiv.innerHTML = "";
        const sorted = data.hand.sort((a,b) => {
            const n1 = parseInt(a.slice(1)), n2 = parseInt(b.slice(1));
            const s1 = ["D","H","S","K"].indexOf(a[0]);
            const s2 = ["D","H","S","K"].indexOf(b[0]);
            return s1 - s2 || n1 - n2;
        });

        sorted.forEach(card => {
            const c = document.createElement("img");
            c.src = `/static/cards/${card}.png`;
            c.className = "card";
            c.onclick = () => socket.emit("play_card", { username, room, card });
            handDiv.appendChild(c);
        });
    }
});

// ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
// suits è¡Œã®é †ç•ªï¼ˆä¸Šâ†’ä¸‹ï¼‰

/**
 * table ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æç”»ç”¨ã® 2D é…åˆ— (4 x 13) ã‚’è¿”ã™ã€‚
 * ã‚µãƒ¼ãƒãƒ¼ãŒ {hearts:[], ...} åˆ¥å½¢å¼ [[...],[...]] ã®ã©ã¡ã‚‰ã§ã‚‚æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
 */
function normalizeTableData(tableData) {
  if (!tableData) return Array.from({length:4}, () => Array(13).fill(null));

  // æ—¢ã« 2æ¬¡å…ƒé…åˆ—ï¼ˆè¡Œã”ã¨ã®é…åˆ—ï¼‰ã§æ¸¡ã•ã‚Œã¦ã„ã‚‹å ´åˆ
  if (Array.isArray(tableData) && Array.isArray(tableData[0])) {
    // ensure size 4x13
    const out = [];
    for (let i = 0; i < 4; i++) {
      out[i] = (tableData[i] && tableData[i].slice(0,13)) || Array(13).fill(null);
      // pad if short
      while (out[i].length < 13) out[i].push(null);
    }
    return out;
  }

  // è¾æ›¸å½¢å¼ã®å ´åˆ: {hearts: [...], spades: [...], ...}
  const out = [];
  for (let i = 0; i < suits.length; i++) {
    const s = suits[i];
    const row = (tableData[s] && tableData[s].slice(0,13)) || Array(13).fill(null);
    while (row.length < 13) row.push(null);
    out.push(row);
  }
  return out;
}

// ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
socket.on("update_table", data => {
  console.log("ğŸ“¥ update_table å—ä¿¡:", data);
  // data ãŒ {table: ...} ã®å ´åˆã¨ã€ç›´æ¥ table ã‚’é€ã£ã¦ã„ã‚‹å ´åˆã«å¯¾å¿œ
  const tableRaw = data.table || data;
  const table = normalizeTableData(tableRaw);

  const tableDiv = document.getElementById("table");
  // æ—¢ã« grid ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã«ã€DOM ã‚’å®Œå…¨ã«å…¥ã‚Œæ›¿ãˆã‚‹ï¼ˆç¢ºå®Ÿï¼‰
  tableDiv.innerHTML = "";

  // 13Ã—4 ã‚’ grid ã®é †ç•ªã§åŸ‹ã‚ã‚‹ï¼ˆrow majorï¼‰
  for (let i = 0; i < 4; i++) {
    for (let j = 0; j < 13; j++) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.id = `slot-${i}-${j}`; // ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ id

      const cardName = table[i][j];
      if (cardName && typeof cardName === "string" && cardName.trim() !== "") {
        // ä¾‹: "H7" ã‚’æƒ³å®šã€‚ç”»åƒãƒ‘ã‚¹ã¯ cardName ã¨åŒåã® png
        const img = document.createElement("img");
        img.className = "card";
        img.src = `/static/cards/${cardName}.png`;
        img.alt = cardName;

        // ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã‹ã£ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã§ç©ºç™½ã«ã™ã‚‹
        img.onerror = () => {
          console.warn("ã‚«ãƒ¼ãƒ‰ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—:", img.src);
          slot.innerHTML = ""; // å¤±æ•—ã—ãŸã‚‰ä½•ã‚‚è¡¨ç¤ºã—ãªã„
        };

        slot.appendChild(img);
      }

      tableDiv.appendChild(slot);
    }
  }
});

socket.on("announce_turn", data => {
    alert(`${data.player} ã®ã‚¿ãƒ¼ãƒ³ã§ã™ï¼`);
});


socket.on("card_played", data => {
    // å ´ã®æ›´æ–°
    for (const suit in data.table) {
        const suitDiv = document.getElementById(suit.toLowerCase());
        suitDiv.textContent = data.table[suit].join(" ");
    }
});
</script>
</body>
</html>
