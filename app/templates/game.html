<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>七並べ</title>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
#hand { margin: 20px; }
.card { display: inline-block; width: 60px; height: 90px; border: 1px solid #000; text-align:center; line-height:90px; margin: 3px; cursor:pointer; }
#table { margin: 20px; }
.suit { margin: 10px 0; }
</style>
</head>
<body>
<h1>オンライン七並べ</h1>
<div id="table"
     style="
        display: grid;
        grid-template-columns: repeat(13, 60px);
        grid-template-rows: repeat(4, 90px);
        gap: 2px;
        justify-content: center;
        margin-top: 40px;
        background-color: #0b6623;
        padding: 10px;
        border-radius: 8px;
     ">
</div>
    <div class="suit" id="hearts"></div>
    <div class="suit" id="spades"></div>
    <div class="suit" id="diamonds"></div>
    <div class="suit" id="clubs"></div>
</div>

<h3>あなたの手札</h3>
<div id="hand"
     style="
        position: fixed;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 5px;
        background-color: rgba(255,255,255,0.2);
        padding: 10px;
        border-radius: 10px;
     ">
</div>
<script>
const socket = io();

const username = "{{ username }}";
const room = "{{ room_id }}"; // 簡易版: 固定ルーム

console.log("usename : " + username);
console.log("room_id : " + room);
socket.emit("join_game", {username, room});
const suits = ["H", "S", "D", "K"]; // 各スートを上から順に行として使う
const suitNames = { H: "hearts", S: "spades", D: "diamonds", K: "clubs" };

/*
socket.on("update_hands", hands => {
    const myHand = hands[username];

    // 🔹 コンソールに自分の手札を表示
    console.log("📥 受信した手札:", myHand);
    const handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";
    myHand.forEach(card => {
        const c = document.createElement("div");
        c.className = "card";
        c.textContent = card;
        c.onclick = () => {
            socket.emit("play_card", {username, room, card});
        }
        handDiv.appendChild(c);
    });
});
*/
function initTable() {
    const table = document.getElementById("table");
    table.innerHTML = "";

    // 各スート行に13列のセルを作成
    for (let row = 0; row < suits.length; row++) {
        for (let col = 1; col <= 13; col++) {
            const cell = document.createElement("div");
            cell.id = `${suits[row]}${col}_cell`;
            cell.style.width = "60px";
            cell.style.height = "90px";
            cell.style.border = "1px solid #444";
            cell.style.borderRadius = "6px";
            cell.style.backgroundColor = "rgba(255,255,255,0.1)";
            cell.style.display = "flex";
            cell.style.alignItems = "center";
            cell.style.justifyContent = "center";
            table.appendChild(cell);
        }
    }
}

initTable();

function sortCards(cards) {
    const order = { H: 0, S: 1, D: 2, K: 3 };
    return cards.sort((a, b) => {
        const suitA = order[a[0]];
        const suitB = order[b[0]];
        if (suitA !== suitB) return suitA - suitB;
        return parseInt(a.slice(1)) - parseInt(b.slice(1));
    });
}


socket.on("update_hands", hands => {
    console.log("hands:", hands);

    // 自分の手札だけ表示
    const myHand = hands[username];
    if (!myHand) return;
    const suitsOrder = ["H","S","D","K"];
    let sortedHand = sortCards([...myHand]);


    const handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";

    for (const suit of suits) {
        const seven = `${suit}7`;
        if (sortedHand.includes(seven)) {
            const cell = document.getElementById(`${seven}_cell`);
            if (cell) {
                const img = document.createElement("img");
                img.src = `/static/cards/${seven}.png`;
                img.alt = seven;
                img.style.width = "60px";
                img.style.height = "90px";
                cell.appendChild(img);
            }
            // 手札から削除
            sortedHand = sortedHand.filter(c => c !== seven);
        }
    }

    myHand.forEach(card => {
        const c = document.createElement("div");
        c.className = "card";
        
        const img = document.createElement("img");
        img.src = `/static/cards/${card}.png`;
        img.alt = card;
        img.style.width = "60px";
        img.style.height = "90px";
        img.style.cursor = "pointer";

        img.onclick = () => {
            socket.emit("play_card", {username, room, card});
        };

        c.appendChild(img);
        handDiv.appendChild(c);
    });

    

});


socket.on("card_played", data => {
    // 場の更新
    for (const suit in data.table) {
        const suitDiv = document.getElementById(suit.toLowerCase());
        suitDiv.textContent = data.table[suit].join(" ");
    }
});
</script>
</body>
</html>
